# RBAC Permission Configuration Guide

## Understanding the Permission System

The Wajiwa dashboard uses a **resource-action** based permission model where:

- **Resource**: Feature or module (e.g., 'users', 'campaigns', 'whatsapp')
- **Action**: Operation type ('read', 'create', 'update', 'delete')

## Default Roles & Permissions

### Admin Role

Full system access with all permissions:

```json
{
  "name": "admin",
  "description": "Administrator with full access",
  "permissions": [
    { "resource": "dashboard", "action": "read" },
    { "resource": "users", "action": "read" },
    { "resource": "users", "action": "create" },
    { "resource": "users", "action": "update" },
    { "resource": "users", "action": "delete" },
    { "resource": "campaigns", "action": "read" },
    { "resource": "campaigns", "action": "create" },
    { "resource": "campaigns", "action": "update" },
    { "resource": "campaigns", "action": "delete" },
    { "resource": "whatsapp", "action": "read" },
    { "resource": "whatsapp", "action": "create" },
    { "resource": "whatsapp", "action": "update" },
    { "resource": "crm", "action": "read" },
    { "resource": "crm", "action": "create" },
    { "resource": "crm", "action": "update" },
    { "resource": "ai-agents", "action": "read" },
    { "resource": "ai-agents", "action": "create" },
    { "resource": "ai-agents", "action": "update" },
    { "resource": "team", "action": "read" },
    { "resource": "team", "action": "create" },
    { "resource": "team", "action": "update" },
    { "resource": "team", "action": "delete" },
    { "resource": "settings", "action": "read" },
    { "resource": "settings", "action": "update" }
  ]
}
```

### Manager Role

Can manage campaigns and team:

```json
{
  "name": "manager",
  "description": "Manager with team and campaign management",
  "permissions": [
    { "resource": "dashboard", "action": "read" },
    { "resource": "users", "action": "read" },
    { "resource": "campaigns", "action": "read" },
    { "resource": "campaigns", "action": "create" },
    { "resource": "campaigns", "action": "update" },
    { "resource": "whatsapp", "action": "read" },
    { "resource": "crm", "action": "read" },
    { "resource": "crm", "action": "create" },
    { "resource": "crm", "action": "update" },
    { "resource": "ai-agents", "action": "read" }
  ]
}
```

### Agent Role

Can use WhatsApp and CRM only:

```json
{
  "name": "agent",
  "description": "Agent with messaging and basic access",
  "permissions": [
    { "resource": "dashboard", "action": "read" },
    { "resource": "whatsapp", "action": "read" },
    { "resource": "crm", "action": "read" },
    { "resource": "crm", "action": "create" }
  ]
}
```

## Available Resources

| Resource  | Description            | Actions                      |
| --------- | ---------------------- | ---------------------------- |
| dashboard | Dashboard overview     | read                         |
| users     | User management        | read, create, update, delete |
| campaigns | Campaign management    | read, create, update, delete |
| whatsapp  | WhatsApp integration   | read, create, update         |
| crm       | Contact management     | read, create, update         |
| ai-agents | AI agent configuration | read, create, update         |
| team      | Team member management | read, create, update, delete |
| settings  | System settings        | read, update                 |

## Creating a Custom Role

### Step 1: Define Role in Firestore

Navigate to Firestore Console → Create a new document in `roles` collection:

```
Collection: roles
Document ID: <auto-generated>

Fields:
- name (string): "sales-manager"
- description (string): "Sales team manager"
- permissions (array):
  - { resource: "dashboard", action: "read" }
  - { resource: "campaigns", action: "read" }
  - { resource": "campaigns", action: "create" }
  - { resource: "whatsapp", action: "read" }
  - { resource: "crm", action: "read" }
  - { resource: "crm", action: "create" }
  - { resource: "crm", action: "update" }
- createdAt (timestamp)
- updatedAt (timestamp)
```

### Step 2: Assign Users to Role

In the user's document, set:

```
role: "sales-manager"
```

### Step 3: Test Permissions

1. Login with that user account
2. Menu should show only accessible resources
3. Try accessing other resources - should show "Access Denied"

## Frontend Permission Checking

### Using `checkPermission()`

```typescript
import { useAuth } from '@/components/auth/auth-context'

export function MyComponent() {
  const { checkPermission } = useAuth()

  if (!checkPermission('users', 'create')) {
    return <div>You don't have permission to create users</div>
  }

  return <UserCreationForm />
}
```

### Using `RBACGuard`

```typescript
import { RBACGuard } from '@/components/auth/rbac-guard'

export function MyComponent() {
  return (
    <RBACGuard
      resource='users'
      action='delete'>
      <button>Delete User</button>
    </RBACGuard>
  )
}
```

### Using `RBACVisible`

Show/hide elements based on resource access:

```typescript
import { RBACVisible } from '@/components/auth/rbac-guard'

export function MyComponent() {
  return (
    <>
      <h1>Dashboard</h1>

      <RBACVisible resource='users'>
        <UsersList />
      </RBACVisible>

      <RBACVisible resource='campaigns'>
        <CampaignsList />
      </RBACVisible>
    </>
  )
}
```

## Backend Permission Checking

### API Route Protection

```typescript
// app/api/users/route.ts
import { NextRequest, NextResponse } from 'next/server'
import { checkPermission } from '@/lib/auth/rbac'

export async function POST(request: NextRequest) {
  // Get user role from middleware headers
  const role = request.headers.get('x-user-role')

  // Check permission
  if (!checkPermission(role, 'users', 'create')) {
    return NextResponse.json({ error: 'Forbidden' }, { status: 403 })
  }

  // Handle request...
  const body = await request.json()
  // Create user logic here

  return NextResponse.json({ success: true })
}
```

### Utility Function Pattern

```typescript
// lib/auth/rbac.ts
export function checkPermission(
  role: string,
  resource: string,
  action: string
): boolean {
  // This is called server-side with role fetched from Firestore
  // In real implementation, you'd fetch the role permissions from Firestore
  // Here shown as example logic
  return permissions.some(
    (perm) => perm.resource === resource && perm.action === action
  )
}
```

## Security Best Practices

### 1. Never Trust Client-Side Checks

Always validate permissions on the server:

```typescript
// ❌ Bad - Only client check
if (auth.checkPermission('users', 'delete')) {
  await deleteUser() // This gets called on client!
}

// ✅ Good - Server validation
async function deleteUser(userId) {
  const response = await fetch('/api/users/' + userId, {
    method: 'DELETE',
    // Permission checked on server before actually deleting
  })
}
```

### 2. Verify Role Before Processing

Always fetch fresh user data:

```typescript
// ✅ Good - Fetch user role from Firestore
const userDoc = await db.collection('users').doc(userId).get()
const role = userDoc.data().role

// Verify permission with fresh data
if (!checkPermission(role, 'users', 'delete')) {
  return NextResponse.json({ error: 'Forbidden' }, { status: 403 })
}
```

### 3. Validate Token Authenticity

Middleware already does this, but verify in critical operations:

```typescript
// ✅ Good - Multiple validation layers
// 1. Middleware validates JWT token
// 2. API route extracts role from validated token
// 3. API route fetches user from Firestore to verify
// 4. API route checks permission with fresh data
```

### 4. Log Authorization Failures

```typescript
// ✅ Good - Track access denials
console.warn(`Access denied: user ${userId} tried to ${action} on ${resource}`)
// Could be stored in activity_logs collection
```

## Common Scenarios

### Scenario 1: Restrict User Creation to Admins Only

**Role Definition**:

```json
{
  "name": "limited-manager",
  "permissions": [
    { "resource": "dashboard", "action": "read" },
    { "resource": "campaigns", "action": "read" },
    { "resource": "campaigns", "action": "create" }
    // NOTE: No "users" permissions
  ]
}
```

**Component**:

```typescript
<RBACGuard
  resource='users'
  action='create'>
  <CreateUserButton />
</RBACGuard>
```

**API**:

```typescript
if (!checkPermission(role, 'users', 'create')) {
  return NextResponse.json({ error: 'Forbidden' }, { status: 403 })
}
```

### Scenario 2: Allow Managers to Edit Campaigns But Not Delete

**Role Definition**:

```json
{
  "name": "campaign-manager",
  "permissions": [
    { "resource": "campaigns", "action": "read" },
    { "resource": "campaigns", "action": "create" },
    { "resource": "campaigns", "action": "update" }
    // NOTE: No "delete" action
  ]
}
```

**Component**:

```typescript
<RBACGuard resource="campaigns" action="update">
  <EditButton />
</RBACGuard>

<RBACGuard resource="campaigns" action="delete">
  <DeleteButton />
</RBACGuard>
```

### Scenario 3: Create Read-Only Access Role

**Role Definition**:

```json
{
  "name": "viewer",
  "permissions": [
    { "resource": "dashboard", "action": "read" },
    { "resource": "campaigns", "action": "read" },
    { "resource": "crm", "action": "read" },
    { "resource": "whatsapp", "action": "read" }
    // NOTE: Only "read" actions, no create/update/delete
  ]
}
```

Users with this role can see everything but can't modify anything.

## Testing Permissions

### Manual Testing Steps

1. **Login with different roles**:

   - Admin: admin@wajiwa.com / Admin@123456
   - Manager: manager@wajiwa.com / Manager@123456
   - Agent: agent@wajiwa.com / Agent@123456

2. **Verify menu items display correctly**:

   - Admin should see all menu items
   - Manager should see dashboard, campaigns, whatsapp, crm
   - Agent should see dashboard, whatsapp, crm

3. **Test permission checks**:

   - Try accessing /dashboard/team as agent (should fail)
   - Try accessing /dashboard/settings as manager (should fail)
   - Try creating a user as manager (button should be hidden)

4. **Check browser console**:

   - Look for any permission-related errors
   - Verify auth context loaded permissions

5. **Monitor API calls**:
   - DevTools → Network tab
   - Check `/api/auth/rbac` response contains correct permissions

### Automated Testing (Example)

```typescript
// tests/permissions.test.ts
import { checkPermission } from '@/lib/auth/rbac'

describe('RBAC Permissions', () => {
  it('admin should have full access', () => {
    const admin = { role: 'admin', permissions: fullPermissions }
    expect(checkPermission(admin, 'users', 'delete')).toBe(true)
    expect(checkPermission(admin, 'settings', 'update')).toBe(true)
  })

  it('agent should have limited access', () => {
    const agent = { role: 'agent', permissions: agentPermissions }
    expect(checkPermission(agent, 'users', 'delete')).toBe(false)
    expect(checkPermission(agent, 'crm', 'create')).toBe(true)
  })
})
```

## Troubleshooting

### Problem: Menu items not showing for new role

**Solution**:

1. Verify role document exists in Firestore `roles` collection
2. Verify role name matches exactly in user's `role` field
3. Check browser DevTools → Network → `/api/auth/rbac` response
4. Verify permissions array contains the resource with correct action

### Problem: RBACGuard not hiding component

**Solution**:

1. Verify permission exists in role
2. Check resource name matches exactly (case-sensitive)
3. Verify action is one of: 'read', 'create', 'update', 'delete'
4. Check console for errors: `checkPermission returned undefined`

### Problem: API endpoint returning 403 Forbidden

**Solution**:

1. Verify user role in Firestore
2. Check role permissions array
3. Verify API endpoint is checking correct resource/action
4. Check middleware is passing correct role in headers

## Firestore Security Rules

Recommended security rules to protect role configuration:

```javascript
rules_version = '2';
service cloud.firestore {
  match /databases/{database}/documents {
    // Only authenticated users can read
    match /roles/{document=**} {
      allow read: if request.auth != null;
      allow write: if request.auth.token.admin == true;
    }

    // Users can read their own data
    match /users/{userId} {
      allow read: if request.auth.uid == userId || request.auth.token.admin == true;
      allow write: if request.auth.token.admin == true;
    }
  }
}
```

## Resources

- [RBAC Architecture Documentation](./RBAC.md)
- [Getting Started Guide](./GETTING_STARTED.md)
- [Firestore Documentation](https://firebase.google.com/docs/firestore)
